#!/usr/bin/env bash

BIN_NAME=$(basename "$0")
COMMAND_NAME="$1"
ARROW="ï¿«"
RED='\033[0;91m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
NC='\033[0m'

if [[ ! "$COMMAND_NAME" ]] || [[ "$COMMAND_NAME" = "help" ]] || [[ "$COMMAND_NAME" = "-h" ]] || [[ "$COMMAND_NAME" = "--help" ]]; then
	echo -e "$ARROW Usage: ${YELLOW}$BIN_NAME <command>${NC}"
    echo
    echo "Commands:"
    echo "   help             This help message"
    echo "   list             List of all the SSH keys and hosts in the SSH config"
    echo "   list-keys        List of all the SSH keys"
	echo "   list-hosts       List of all the hosts in the SSH config"
    echo "   copy             Copy public SSH key"
    echo "   new              Generate new SSH key"
	echo
fi

if [[ "$COMMAND_NAME" == "list" ]]; then
	"$BIN_NAME" list-keys
	echo ""
	"$BIN_NAME" list-hosts
fi

if [[ "$COMMAND_NAME" = "list-keys" ]]; then
	echo -e "${YELLOW}$ARROW List of available SSH keys:${NC}"

	for file in "$HOME"/.ssh/*.pub
	do
	    echo "- "${file##*/}
	done
fi

if [[ "$COMMAND_NAME" = "list-hosts" ]]; then
	echo -e "${YELLOW}$ARROW List of hosts defined in the SSH config:${NC}"

	awk '/Host (.*)/ { print "- "$2 }' "$HOME/.ssh/config"
fi

if [[ "$COMMAND_NAME" = "copy" ]]; then
	folder="$HOME/.ssh/"
	key="$2"

	if [[ ! "$key" ]]; then
		echo -e "${RED}$ARROW Error: You have to pass a key name. Usage: $BIN_NAME copy <name>${NC}"
	else
		key="id_ed25519_$key.pub"

		if [[ ! -f "$folder$key" ]]; then
	        echo -e "${RED}$ARROW Error: Key $key does not exists in $folder.${NC}"
	    else
			cat "$folder$key" | pbcopy && echo -e "${GREEN}$ARROW Success: Your public SSH key $key was successfully copied to the clipboard.${NC}"
	    fi
	fi
fi

if [[ "$COMMAND_NAME" = "new" ]]; then
	while true; do
		read -p "$(echo -e "${YELLOW}$ARROW Enter key file name:${NC} ")" key

		if [[ -f "$HOME/.ssh/id_ed25519_$key" ]]; then
			echo -e "${RED}$ARROW Error: Key with this file name already exists.${NC}"
		else
			break
		fi
	done

	read -p "$(echo -e "${YELLOW}$ARROW Enter key comment:${NC} ")" comment

	ssh-keygen -o -a 100 -t ed25519 -f "$HOME/.ssh/id_ed25519_$key" -C "$comment"

	echo -e "${GREEN}$ARROW Success: SSH key '$key' was successfully created with comment '$comment'.${NC}"
fi
