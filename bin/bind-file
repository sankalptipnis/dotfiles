#!/usr/bin/env bash

shopt -s nullglob

BIN_NAME=$(basename "$0")
RED='\033[0;91m'
GREEN='\033[0;92m'
YELLOW='\033[0;93m'
RESET='\033[0m'

function usage {
    echo
    echo "USAGE:"
    echo -e "    ${YELLOW}${BIN_NAME}${RESET} app file..."
    echo
    echo "DESCRIPTION:" 
    echo "    This utility sets the input app as the "
    echo "    default app to open the input file(s)."
    echo
}

if [[ "$1" == "help" ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
	usage && exit 1
fi

APP="$1"
[[ -z "${APP// }" ]] && echo -e "${RED}No app specified!${RESET}" && usage && exit 1

APP_ALIAS=$(osascript -e "path to app \"$APP\"")

RETURN_CODE=$?
if [[ "$RETURN_CODE" != "0" ]]; then
    echo -e "${RED}App \"${APP}\" not found!${RESET}"
    exit "$RETURN_CODE"
fi

shift

function change_default_app() {
    local FILE="$1"
    local FILE_ABS="$(abspath -l "$FILE")"

    [[ -z "${FILE_ABS// }" ]] && echo -e "${RED}No file specified!${RESET}" && usage && return 1
    [[ ! -f "$FILE_ABS" ]] && echo -e "${RED}${FILE_ABS}: No such file!${RESET}" && usage && return 1

    osascript <<EOF
    set theFile to "$FILE_ABS"
    log ""
    log "File:"
    log theFile
    set myApp to (path to application "$APP" )
    log "App:"
    log myApp
    tell application "System Events" to set default application of file theFile to myApp
EOF

    RETURN_CODE=$?
    if [[ "$RETURN_CODE" != "0" ]]; then
        echo -e "${RED}Failed to set \"${APP}\" as the default app to open \"${FILE}\"!${RESET}"
        echo
    else
        echo -e "${GREEN}Successfully set \"${APP}\" as the default app to open \"${FILE}\".${RESET}"
        echo
    fi
}

for ARG in "$@"; do
    if [[ -f "$ARG" ]]; then
        change_default_app "$ARG"
    elif [[ -d "$ARG" ]]; then
        OLDIFS="$IFS"
        IFS=$'\n'
        for FILE in "$ARG"/* "$ARG"/.[^.]*; do
            [[ -f "$FILE" ]] && change_default_app "$FILE"
        done
        IFS="$OLDIFS"
    fi
done
