#!/usr/bin/env bash

shopt -s nullglob

BIN_NAME=$(basename "$0")

function usage {
    echo "Usage:"
    echo "$BIN_NAME source_dir target_dir"
    echo
    echo "This utility removes any symlinks from the target directory "
    echo "to files in the source directory."
	echo
    echo "COMMAND LINE OPTIONS:"
	echo
	echo "-D"
	echo "	Removes any symlink in the target directory to the "
	echo "	source directory itself (instead of to files in the source directory)"
	echo
	echo "-x"
    echo "	Broken symlinks in the target directory are removed"
    echo "	before proceeding."
	echo
	echo "-d"
    echo "	The commands are printed out rather than being executed."
    echo
    exit 1
}

if [[ "$1" = "help" ]] || [[ "$1" = "-h" ]] || [[ "$1" = "--help" ]]; then
	usage
fi

DIR="FALSE"
CLEAN="FALSE"
DEBUG="FALSE"

while getopts ':Dxd' flag; do
  case "${flag}" in
	D) DIR="TRUE";;
	x) CLEAN="TRUE";;
	d) DEBUG="TRUE";;
  esac
done

shift $((OPTIND -1))

SOURCE_DIR="$1"
TARGET_DIR="$2"

[[ -z "$SOURCE_DIR" ]] && usage
[[ -z "$TARGET_DIR" ]] && usage

[[ ! -d "$SOURCE_DIR" ]] && echo "The source directory does not exist!" && usage

if [[ "$DEBUG" == "TRUE" ]]; then
	echo
	echo "!!!!!!!!!!!!!!!! PERFORMING DRY RUN !!!!!!!!!!!!!!!!"
	echo
fi

function process_file() { 
	local FILE="$1"
	local TARGET_DIR="$2"
	local DEBUG="$3"

	local FILENAME=$(basename "$FILE")
	local SOURCE_FILE_ABS=$(realpath -e "$FILE")
	local TARGET_FILE_ABS="$TARGET_DIR/$FILENAME"

	# file exists in the the target dir and is a symlink
	if [[ -e "$TARGET_FILE_ABS" && -h "$TARGET_FILE_ABS" ]]; then
		# the symlink is the same file as the input file
		if [[ "$TARGET_FILE_ABS" -ef "$SOURCE_FILE_ABS" ]]; then
			
			# make a copy of the contents of the file
			echo "~~~ COMMAND: cp -fLrv $TARGET_FILE_ABS{,.temp}"					
			if [[ "$DEBUG" == "FALSE" ]]; then
				cp -fLrv "$TARGET_FILE_ABS"{,.temp} || ( echo "Failed to create a backup copy!" && exit 1 )		
			fi
			echo
			
			# remove the symlink
			echo "~~~ COMMAND: rm -rfv $TARGET_FILE_ABS"
			[[ "$DEBUG" == "FALSE" ]] && rm -rfv "$TARGET_FILE_ABS"
			echo
			
			# remove any potential backups of the file
			echo "~~~ COMMAND: rm -rfv $TARGET_FILE_ABS.bak"
			[[ "$DEBUG" == "FALSE" ]] && rm -rfv "$TARGET_FILE_ABS".bak
			echo
			
			# rename the copy from to the original name of the file
			echo "~~~ COMMAND: mv -v $TARGET_FILE_ABS.temp $TARGET_FILE_ABS"
			[[ "$DEBUG" == "FALSE" ]] && mv -v "$TARGET_FILE_ABS".temp "$TARGET_FILE_ABS"
			echo
		fi
	fi
}

if [[ -d "$TARGET_DIR" ]]; then

	echo
	echo "##############################"
	echo "########## CLEANING ##########"
	echo "##############################"

	if [[ "$CLEAN" == "TRUE" ]]; then
		echo
		echo "TARGET DIRECTORY: $TARGET_DIR"
		for FILE in "$TARGET_DIR"/* "$TARGET_DIR"/.[^.]*; do
			# source file is a broken link
			if [[ ! -e "$FILE" && -h "$FILE" ]]; then 						
				echo
				echo "------------------------------"
				echo "File: $FILE"
				echo "------------------------------"
				# remove broken link
				echo "~~~ COMMAND: rm -rfv $FILE"
				[[ "$DEBUG" == "FALSE" ]] && rm -rfv "$FILE"		
				echo						 
			fi
		done
	fi
	
	echo
	echo "##############################"
	echo "######### UNLINKING ##########"
	echo "##############################"

	echo
	echo "SOURCE DIRECTORY: $SOURCE_DIR"
	echo "TARGET DIRECTORY: $TARGET_DIR"
	echo

	if [[ "$DIR" == "FALSE" ]]; then
		OLDIFS="$IFS"
		IFS=$'\n'
		for FILE in "$SOURCE_DIR"/* "$SOURCE_DIR"/.[^.]*; do
			
			echo "------------------------------"
			echo "File: $FILE"
			echo "------------------------------"

			process_file "$FILE"" $TARGET_DIR" "$DEBUG"
		done
		IFS="$OLDIFS"
	else
		process_file "$SOURCE_DIR" "$TARGET_DIR" "$DEBUG"
	fi
fi